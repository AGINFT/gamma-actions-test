name: Scheduled Coherence Check

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  coherence-check:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Check coherence metrics
        id: coherence
        run: |
          echo "ðŸœ‚ Verificando coherencia Ï†^7 del sistema ðŸœ‚"
          
          PHI_7=29.034095516850073
          
          if [ -f MASTER_INDEX.json ]; then
            CURRENT_COHERENCE=$(cat MASTER_INDEX.json | \
              grep -o '"coherence_phi": [0-9.]*' | \
              head -1 | cut -d' ' -f2 || echo "0.618")
            
            echo "Coherencia actual: $CURRENT_COHERENCE"
            echo "Target Ï†^7: $PHI_7"
            
            DISTANCE=$(echo "$PHI_7 - $CURRENT_COHERENCE" | bc -l 2>/dev/null || echo "28.416")
            echo "Distancia a Ï†^7: $DISTANCE"
            
            echo "COHERENCE=$CURRENT_COHERENCE" >> $GITHUB_OUTPUT
            echo "DISTANCE=$DISTANCE" >> $GITHUB_OUTPUT
          else
            echo "âš  MASTER_INDEX.json no encontrado"
            echo "COHERENCE=0.000" >> $GITHUB_OUTPUT
            echo "DISTANCE=29.034" >> $GITHUB_OUTPUT
          fi
      
      - name: Create coherence report
        run: |
          mkdir -p memories/coherence
          
          COHERENCE="${{ steps.coherence.outputs.COHERENCE }}"
          DISTANCE="${{ steps.coherence.outputs.DISTANCE }}"
          
          cat > memories/coherence/report-$(date +%Y-%m-%d).json <<JSONEOF
{
  "date": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
  "coherence_phi": ${COHERENCE:-0.618},
  "target_phi_7": 29.034095516850073,
  "distance": ${DISTANCE:-28.416},
  "status": "OPERATIONAL"
}
JSONEOF
          
          echo "âœ“ Reporte de coherencia creado"
          cat memories/coherence/report-$(date +%Y-%m-%d).json
      
      - name: Commit coherence report
        run: |
          git config user.name "Gamma Bot"
          git config user.email "gamma-bot@aginft.local"
          
          git add memories/coherence/ || true
          
          if git diff --staged --quiet; then
            echo "No hay cambios en coherence reports"
          else
            git commit -m "ðŸœ‚ Coherence report $(date +%Y-%m-%d) [Ï†=${{ steps.coherence.outputs.COHERENCE }}]"
            git push
          fi
